# Automatically build the project and run any configured tests for every push
# and submitted pull request. This can help catch issues that only occur on
# certain platforms or Java versions, and provides a first line of defence
# against bad commits.

name: build
on:
  pull_request:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to count commits
      
      - name: validate gradle wrapper
        uses: gradle/actions/wrapper-validation@v4
      
      - name: setup jdk
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'microsoft'
      
      - name: make gradle wrapper executable
        run: chmod +x ./gradlew
      
      - name: build
        run: ./gradlew build
      
      - name: capture build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Artifacts
          path: build/libs/
      
      # Check if we should release (every 5-10 commits)
      - name: check if release needed
        id: check_release
        run: |
          # Get the latest release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            # No tags yet, count all commits
            COMMIT_COUNT=$(git rev-list --count HEAD)
          else
            # Count commits since last tag
            COMMIT_COUNT=$(git rev-list --count ${LATEST_TAG}..HEAD)
          fi
          
          echo "Commits since last release: $COMMIT_COUNT"
          
          # Release if we have 5+ commits (you can change this to 10 if you want)
          if [ $COMMIT_COUNT -ge 5 ]; then
            echo "SHOULD_RELEASE=true" >> $GITHUB_OUTPUT
            echo "✅ Time to drop a release!"
          else
            echo "SHOULD_RELEASE=false" >> $GITHUB_OUTPUT
            echo "❌ Not enough commits yet ($COMMIT_COUNT/5)"
          fi
      
      # Get version from tag or commit
      - name: get version
        if: steps.check_release.outputs.SHOULD_RELEASE == 'true' || startsWith(github.ref, 'refs/tags/v')
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +'%Y.%m.%d')-${GITHUB_SHA::7}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      # Create release if enough commits OR if a version tag was pushed
      - name: create release
        if: steps.check_release.outputs.SHOULD_RELEASE == 'true' || startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          files: build/libs/*.jar
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Publish to Modrinth alongside the GitHub release
      - name: publish to modrinth
        if: steps.check_release.outputs.SHOULD_RELEASE == 'true' || startsWith(github.ref, 'refs/tags/v')
        run: ./gradlew modrinth
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
